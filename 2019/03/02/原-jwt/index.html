<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="yan"><meta name="keywords" content="闫大雨，前端，博客"><meta name="description" content="个人博客"><link rel="alternative" href="/atom.xml" title="Hey 这里是闫大雨" type="application/atom+xml"><link rel="icon" href="/img/h2.gif"><title>[原]jwt - Hey 这里是闫大雨</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">Hey 这里是闫大雨</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">カタログ/（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2019-03-02T13:23:51.000Z">三月 2, 2019</time><h1 class="post__title"><a href="/2019/03/02/原-jwt/">[原]jwt</a></h1><div class="post__main echo"><h2 id="jwt"><a href="#jwt" class="headerlink" title="jwt"></a>jwt</h2><p>jwt是jsonwebtoken的简称，用来生成token。在登陆状态验证完成时发送给前台一个token，之后前台的请求都要带着token，后台验证其token的正确性及有效性之后才会回应其数据，在用户和服务器端之间安全的传递消息。<br>jwt实际是一个字符串，由三部分组成，头部，数据和签名。</p>
<h2 id="生成token"><a href="#生成token" class="headerlink" title="生成token"></a>生成token</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>)</span><br></pre></td></tr></table></figure>
<p>我们在页面引入jsonwebtoken后，可以使用其方法sign来生成token.</p>
<p><code>jwt.sign(payload,secret,[options,callback])</code></p>
<p>sign方法有四个参数，第一个是生成的token中包含的一些数据，此参数可以是一个对象，字符串或buffer。如果是对象，会使用JSON.stringify()转为json格式。我在对象中写入了一个GUID(时间戳)和user-agent信息;<br>第二个参数是一个密钥，记录在服务器中，在验证时需要用到此参数;<br>第三个是一些选项，经常用的大概就是有效期(expiresIn)，有效期的值以秒计数，也可以使用一些带有时间跨度的字符串，eg：’7d’,’5h’等;<br>第四个是一个回调，回调的第一个参数是err,第二个是token。但此方法会默认返回token;</p>
<h2 id="下面是贴了实例的代码，在其中还使用了level存储了一个状态和时间"><a href="#下面是贴了实例的代码，在其中还使用了level存储了一个状态和时间" class="headerlink" title="下面是贴了实例的代码，在其中还使用了level存储了一个状态和时间"></a>下面是贴了实例的代码，在其中还使用了level存储了一个状态和时间</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>);</span><br><span class="line"><span class="keyword">const</span> level = <span class="built_in">require</span>(<span class="string">'level'</span>);</span><br><span class="line"><span class="comment">// 创建实例</span></span><br><span class="line"><span class="keyword">var</span> db = level(<span class="string">'./mydb'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 密钥</span></span><br><span class="line"><span class="keyword">var</span> serect = <span class="string">'yandayu'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取GUID</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateGULD</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Date</span>().getTime()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成token</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateToken</span>(<span class="params">req, GUID, opts</span>) </span>&#123;</span><br><span class="line">    opts = opts || &#123;&#125;</span><br><span class="line">    <span class="comment">// 默认有效期为7天</span></span><br><span class="line">    <span class="keyword">var</span> expiresDefault = <span class="string">'7d'</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> token = jwt.sign(&#123;</span><br><span class="line">        auth: GUID,</span><br><span class="line">        agent: req.headers[<span class="string">'user-agent'</span>]</span><br><span class="line">    &#125;, serect, &#123; <span class="attr">expiresIn</span>: opts.expires || expiresDefault &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> token;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateAndStoreToken</span>(<span class="params">req, opts</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> GUID = generateGULD();</span><br><span class="line">    <span class="keyword">var</span> token = generateToken(req, GUID, opts)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> record = &#123;</span><br><span class="line">        valid: <span class="literal">true</span>,</span><br><span class="line">        created: <span class="keyword">new</span> <span class="built_in">Date</span>().getTime()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 使用level把数据插入存储区</span></span><br><span class="line">    db.put(GUID, <span class="built_in">JSON</span>.stringify(record), <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> token;</span><br><span class="line">&#125;</span><br><span class="line">exports = <span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    generateAndStoreToken</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="验证token"><a href="#验证token" class="headerlink" title="验证token"></a>验证token</h2><p>在之后前台的操作中需要传回token，后台进行验证。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用`jwt.verify` 方法传入token和密钥，如果有效会返回当时使用sign方法传入的第一个参数,通过验证其是否返回的是有效参数来确认其token是否有效。</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">verify</span>(<span class="params">token</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> decoded = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        decoded = jwt.verify(token, secret);</span><br><span class="line">       </span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        decoded = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> decoded;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 校验token的中间件方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkToken</span>(<span class="params">req,res,next</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> token = req.headers.authorization;</span><br><span class="line">    <span class="keyword">var</span> decoded = verify(token);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!decoded || !decoded.auth)&#123;</span><br><span class="line">        res.checkToken = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> next()</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 并且在当时使用了level把GUID作为键值对的键，所以可以通过verify方法返回数据中的GUID来获取值中存储的有效与否来再次检验是否有效。</span></span><br><span class="line">        db.get(decoded.auth,<span class="function"><span class="keyword">function</span>(<span class="params">err,recode</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                recode = <span class="built_in">JSON</span>.parse(recode)</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                recode = &#123; <span class="attr">valid</span>: <span class="literal">false</span> &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(err || !recode.valid)&#123;</span><br><span class="line">                res.checkToken = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">return</span> next()</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                res.checkToken = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">return</span> next()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/jwt/">jwt</a></li></ul></footer></article><div class="comments" id="lv-container" data-id="city" data-uid="your uid"><script>(function(d, s) {var j, e = d.getElementsByTagName(s)[0];if (typeof LivereTower === 'function') { return; } j = d.createElement(s);j.src = 'https://cdn-city.livere.com/js/embed.dist.js';j.async = true;e.parentNode.insertBefore(j, e);})(document, 'script');</script></div></main><footer class="foot"><div class="foot-copy">&copy; 2016-2019 yan</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>