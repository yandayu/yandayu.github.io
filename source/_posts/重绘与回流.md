---
title: '重绘与回流'
categories:
- 前端
tags:
- javascript
date: 2019-07-12 20:26:40
---
### 浏览器的渲染过程
首先浏览器会解析HTML文档形成dom树，css样式表解析为样式结构体（浏览器只保留识别后的样式，会去掉不识别的前缀），之后结合dom树和样式结构体形成渲染树，这时每个节点都有自己的样式，但渲染树不会包含隐藏的元素，当这些元素需要渲染出来展示给用户时也就会产生回流，紧接着浏览器在渲染树内对每个节点进行布局处理，计算出每个元素的大小位置等，确定其在屏幕上的位置，最后绘制，通过遍历渲染树将实际的像素显示到屏幕上。

所以每个页面在首次渲染时必然会产生一次回流。
### 重绘  
当dom树的一些元素需要更新属性，而这些属性只是影响元素的外观与风格不会影响布局的成为重绘。也就是说改变外观不改变布局不影响其他dom。

### 回流
浏览器为了重新渲染部分或全部的文档而重新计算文档中元素的位置和几何结构的过程。有时候一个元素的回流会导致其所有子元素以及dom中紧随其后的祖先元素的随后的回流。

### 影响

**回流必然会引发重绘，但重绘不一定会引起回流**

回流比重绘所带来的计算量更大，代价更高，我们应该尽可能的去避免它。

### 哪些操作会引起回流？
1. 用户调整窗口大小
2. 用户改变浏览器字体大小
3. 增加或移除改变布局的样式
4. 用户在输入框输入文字时
5. 激活css伪类
6. 操作class属性
7. 脚本操作dom
8. 计算offsetWidth/offsetHeight
9. 设置style属性的值
10. fixed定位的元素在拖动滚动条时会一直回流（给元素加transform:translate3d(0px,0px,0px)会减少这种情况）

eg:display:none（重绘+回流），visibility:hidden （重绘）

### 我们如何避免回流？

1. 减少不必要的dom深度，回流时自上而下的，例如在body开始标签后添加元素，那么下面的所有元素都会回流，但如果在body结束标签前加，不会影响其他元素
2. 精简css
3. 应用动画的元素配合position:absolute
4. 合并多个样式修改，改变className去修改多个样式，动态改变样式使用cssText

### 浏览器自身优化机制

因为页面往往伴随着动画和用户响应的过程，所以页面的回流也会很频繁，浏览器为了减少这种压力，浏览器会去维护一个队列，把所有会引起回流重绘的操作放入这个队列，登队列中的操作到了一定的数量或者到了一定的时间间隔浏览器就会清除这个队列，进行一个批处理，这样就会让多次的回流重绘变成一次操作，从而减轻压力。

但是我们在开发过程中对于节点当前的宽高或者浏览器的scrollTop/offsetWidth等的一些样式进行请求时，浏览器为了给我们一个精确的值会强制执行此队列，因为队列中的回流重绘可能改变我们请求的结果，

