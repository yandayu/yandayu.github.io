---
title: '[转]全局捕获'
categories:
- 前端
tags:
- javascript
date: 2018-11-15 09:15:18
---

## 全局捕获的理解

全局捕获只支持鼠标事件，不支持键盘事件。

> 全局捕获： 全局（包含浏览器外）出现一个鼠标事件，会被设置全局捕获的对象捕获，如果此对象正好有对应的事件函数，
> 
> 那么会被触发，而最初的发起事件的元素就不会执行它的事件函数了，通俗点说就是事件被掠走了。
> 
> 全局捕获只能执行一次捕获的事件，如果持续捕获可能会出现问题，可以想象下：
> 
> 如果全局捕获点击事件，鼠标无论点击哪里都会执行那段代码，那么连最基本的关闭浏览器窗口都不行了。
> 
> 如果持续捕获，必须有取消全局捕获。


--------------------- 
作者：jerny2017 
来源：CSDN 
原文：https://blog.csdn.net/jerny2017/article/details/80282502 


>setCapture函数的作用就是将后续的mouse事件都发送给这个对象releaseCaptur就是将鼠标事件还回去，由 document、window、object之类的自行来处理。这样就保证了在拖动的过程中，不会由于经过了其它的元素而受到干扰
另外，还有一个很重 要的事情是，在Win32上，mouse move的事件不是一个连续的，也就是说，并不是我们每次移动1px的鼠标指针，就会发生一个mousemove，windows会周期性检查mouse 的位置变化来产生mousemove的事件。 
所以，如果是一个很小的页面对象，比如一个直径5px的圆点，如果没有setCapture和 releaseCapture，那么在鼠标按住之后，快速的移动鼠标，就有可能鼠标移动走了，但是小圆点还在原地，就是因为下一次的mousemove事 件已经不再发给这个圆点对象了。 


>web开发和windows开发最大的区别就是windows开发是有状态的，而web开发是无状态的，在windows中，一切操作都可以由程序来控制 ，除非强制执行ctrl+alt+del；但web操作就不一样了，即使执行很重要的操作，用户一点击浏览器关闭按钮，就将前面操作成果化为乌有.尽管可以在onunload事件中加些代码，让用户可以选择是否退出，但不能从根本上解决问题! 

>前几天，从网上看到setCapture方法，了解了一下，大体是这样的意思，当在IE文档某个区域中使用了这个方法，并且写了onclick或者 onmouse***等有关的鼠标事件方法，那么它就会监视相应的鼠标操作，即使你的鼠标移出了IE，它也一样能捕获到.如果你在某div中的 onclick事件中写了一个alert命令，这时，你点击的关闭按钮，它也一样会弹出alert窗口.releaseCapture与 setCapture方法相反，释放鼠标监控. 

>利用这个特性，我们可以延缓IE的关闭窗口等破坏性操作，将一些重要的操作能够在破坏性操作执行之前得到处理. 
有一点遗憾:setCapture和releaseCapture 不支持键盘事件.只对onmousedown， onmouseup， onmousemove， onclick， ondblclick， onmouseover， onmouseout这样的鼠标事件起作用. 

下面是一个小例子，若我们要对divMain这个div元素里面的内容进行保护: 

1.对divMain执行setCapture方法: 
document.getElementById("divMain").setCapture()； 

2.加入一按钮btnChange，可以进行setCapture和releaseCapture切换，定义一全局变量； 
var isFreeze = true； 

3.在btnChange的onclick事件中，加入下列代码: 
 
```javascript
    function change_capture(obj) { 
    isFreeze = !isFreeze; 
    if(isFreeze) { 
    obj.value = "releaseCapture"; 
    document.getElementById("divMain").setCapture(); 
    } else { 
    obj.value = "setCapture"; 
    alert('保存！'); //可以执行重要操作 
    document.getElementById("divMain").releaseCapture(); 
    } 
    } 

divMain的onclick事件中，加入下列代码: 
复制代码 代码如下:

    function click_func() 
    { 
    if(event.srcElement.id == "divMain") 
    { 
    alert("处理中...")； //常规操作 
    document.getElementById("divMain").setCapture()； 
    } 
    else 
    { 
    if(isFreeze && event.srcElement.id != "btnChange") 
    { 
    alert('未执行releaseCapture，不能点击')； 
    document.getElementById("divMain").setCapture()； 
    } 
    } 
    } 

对ALT+F4进行处理，在body的onkeydown事件中加入下列代码: 
复制代码 代码如下:

    function keydown_func() 
    { 
    if (event.keyCode==115 && event.altKey) //ALT+F4 
    { 
    if(isFreeze) 
    { 
    alert('保存！')； //可以执行重要操作 
    } 
    //window.showModelessDialog("about:blank"，""，"dialogWidth:1px；dialogheight:1px")； 
    //return false； 
    } 
    document.getElementById("divMain").setCapture()； 
    } 
```
完整代码如下: 

```html
    <html> 
    <head> 
    <title> 
    setCapture和releaseCapture的小应用 
    </title> 
    <script> 
    < !-- 
    var isFreeze = true; 
    function click_func() { 
    if (event.srcElement.id == "divMain") { 
    alert("处理中..."); //常规操作 
    document.getElementById("divMain").setCapture(); 
    } else { 
    if (isFreeze && event.srcElement.id != "btnChange") { 
    alert('未执行releaseCapture,不能点击'); 
    document.getElementById("divMain").setCapture(); 
    } 
    } 
    } 
    function keydown_func() { 
    if (event.keyCode == 115 && event.altKey) //ALT+F4 
    { 
    if (isFreeze) { 
    alert('保存！'); //可以执行重要操作 
    } 
    //window.showModelessDialog("about:blank","","dialogWidth:1px;dialogheight:1px"); 
    //return false; 
    } 
    document.getElementById("divMain").setCapture(); 
    } 
    function change_capture(obj) { 
    isFreeze = !isFreeze; 
    if (isFreeze) { 
    obj.value = "releaseCapture"; 
    document.getElementById("divMain").setCapture(); 
    } else { 
    obj.value = "setCapture"; 
    alert('保存！'); //可以执行重要操作 
    document.getElementById("divMain").releaseCapture(); 
    } 
    } 
    //--> 
    </script> 
    </head> 
    <body onkeydown="keydown_func();"> 
    <div id="divMain" onclick="click_func();"> 
```
点一下IE的菜单或者按钮看看:) 又或者IE窗口外的地方 
```javascript
    <input type="button" value="releaseCapture" onclick="change_capture(this);" 
    id="btnChange"> 
    <script language="javascript"> 
    document.getElementById("divMain").setCapture(); 
    </script> 
    </div> 
    </body> 
    </html> 
```

